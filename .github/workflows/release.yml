name: è‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒå¤šæµè§ˆå™¨æ‰©å±•

on:
    push:
        branches: [main]
        paths:
            - 'package.json' # åªæœ‰å½“ package.json ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
    contents: write
    pull-requests: write

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è¯»å–ç‰ˆæœ¬å·
              id: get_version
              run: |
                  VERSION=$(cat package.json | jq -r '.version')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "å½“å‰ç‰ˆæœ¬: $VERSION"

            - name: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ Release
              id: check_release
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  if gh release view "v$VERSION" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "ç‰ˆæœ¬ v$VERSION çš„ Release ä¸å­˜åœ¨ï¼Œç»§ç»­å‘å¸ƒ"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: å®‰è£…ä¾èµ–
              if: steps.check_release.outputs.exists == 'false'
              run: npm ci

            - name: åˆ›å»ºå¤šæµè§ˆå™¨æ‰©å±•åŒ…
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  CHROME_PACKAGE="B2Y-YouTube-Bilibili-Danmaku-v$VERSION-chrome.zip"
                  FIREFOX_PACKAGE="B2Y-YouTube-Bilibili-Danmaku-v$VERSION-firefox.zip"
                  EDGE_PACKAGE="B2Y-YouTube-Bilibili-Danmaku-v$VERSION-edge.zip"
                  SAFARI_PACKAGE="B2Y-YouTube-Bilibili-Danmaku-v$VERSION-safari.zip"

                  # æ„å»º Chrome ç‰ˆæœ¬
                  echo "ğŸ”¨ æ„å»º Chrome æ‰©å±•..."
                  npm run build:chrome

                  # æ‰“åŒ… Chrome ç‰ˆæœ¬
                  cd .output/chrome-mv3
                  zip -r "../../$CHROME_PACKAGE" .
                  cd ../..

                  # æ„å»º Firefox ç‰ˆæœ¬  
                  echo "ğŸ”¨ æ„å»º Firefox æ‰©å±•..."
                  npm run build:firefox

                  # æ‰“åŒ… Firefox ç‰ˆæœ¬
                  cd .output/firefox-mv2
                  zip -r "../../$FIREFOX_PACKAGE" .
                  cd ../..

                  # æ„å»º Edge ç‰ˆæœ¬
                  echo "ğŸ”¨ æ„å»º Edge æ‰©å±•..."
                  npm run build:edge

                  # æ‰“åŒ… Edge ç‰ˆæœ¬
                  cd .output/edge-mv3
                  zip -r "../../$EDGE_PACKAGE" .
                  cd ../..

                  # æ„å»º Safari ç‰ˆæœ¬
                  echo "ğŸ”¨ æ„å»º Safari æ‰©å±•..."
                  npm run build:safari

                  # æ‰“åŒ… Safari ç‰ˆæœ¬
                  cd .output/safari-mv2
                  zip -r "../../$SAFARI_PACKAGE" .
                  cd ../..

                  echo "âœ… æ‰©å±•åŒ…åˆ›å»ºå®Œæˆ:"
                  echo "ğŸ“¦ Chrome: $CHROME_PACKAGE"
                  echo "ğŸ“¦ Firefox: $FIREFOX_PACKAGE"
                  echo "ğŸ“¦ Edge: $EDGE_PACKAGE"
                  echo "ğŸ“¦ Safari: $SAFARI_PACKAGE"

                  echo "chrome_package=$CHROME_PACKAGE" >> $GITHUB_ENV
                  echo "firefox_package=$FIREFOX_PACKAGE" >> $GITHUB_ENV
                  echo "edge_package=$EDGE_PACKAGE" >> $GITHUB_ENV
                  echo "safari_package=$SAFARI_PACKAGE" >> $GITHUB_ENV

            - name: åˆ›å»º Release
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  CHROME_PACKAGE="${{ env.chrome_package }}"
                  FIREFOX_PACKAGE="${{ env.firefox_package }}"
                  EDGE_PACKAGE="${{ env.edge_package }}"
                  SAFARI_PACKAGE="${{ env.safari_package }}"

                  # åˆ›å»º Release å¹¶ä¸Šä¼ å¤šæµè§ˆå™¨åŒ…
                  gh release create "v$VERSION" \
                    --title "v$VERSION" \
                    --generate-notes \
                    "$CHROME_PACKAGE" \
                    "$FIREFOX_PACKAGE" \
                    "$EDGE_PACKAGE" \
                    "$SAFARI_PACKAGE"
                    
                  echo "âœ… Release v$VERSION åˆ›å»ºæˆåŠŸï¼ŒåŒ…å« Chromeã€Firefoxã€Edge å’Œ Safari ç‰ˆæœ¬"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: è¾“å‡ºç»“æœ
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  echo "ğŸ‰ å¤šæµè§ˆå™¨æ‰©å±• v$VERSION å·²æˆåŠŸæ„å»ºå¹¶å‘å¸ƒåˆ° Release!"
                  echo "ğŸŒ æ”¯æŒæµè§ˆå™¨:"
                  echo "  âœ… Chrome (Manifest V3)"
                  echo "  âœ… Firefox (Manifest V2)"
                  echo "  âœ… Edge (Manifest V3)" 
                  echo "  âœ… Safari (Manifest V3)"
                  echo "ğŸ›  æ„å»ºæŠ€æœ¯: WXT Framework"
                  echo "ğŸ“ æ„å»ºäº§ç‰©: .output/chrome-mv3/, .output/firefox-mv2/, .output/edge-mv3/, .output/safari-mv2/"

            - name: è·³è¿‡å‘å¸ƒæç¤º
              if: steps.check_release.outputs.exists == 'true'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  echo "â„¹ï¸  ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒ"
